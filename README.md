<h1>Интеграция с банком</h1>



<ol>
<li> Бизнес-процесс</li> 
<li> Модель данных</li>
<li> [Backend] Сервисы для реализации</li>
<ul>
  <ul> 3.1. Получение списка карт пользователя </ul>
  <ul> 3.2. Создание заказа на тестовое списание </ul>
  <ul> 3.3. Получить данные сохраненной карты и отменить оплату </ul>
 </ul>
<li> Используемые сервисы для интеграции</li>
<li> Критерии приемки</li>
<ul>
 <ul> 5.1. Сохранение карты работником </ul>
</ul>
</ol>



<h2>1. Бизнес-процесс </h2>


sequenceDiagram 
```
user->>+frontend: "Добавить карту"
frontend->>+backend: initNewCard 
backend->>bank: registerPreAuth 
bank-->>backend: orderId, url 
backend->>-frontend: orderId, url 
frontend->>+user: webView по url 
user->>+frontend: "Оплатить" 
frontend->>+frontend: ловит callback c returnUrl 
frontend->>+backend: saveCard 
backend->>bank: getOrderStatusExtended
bank-->>backend: bindingId 
backend->>bank: reverse 
bank-->>backend: response 
backend->>-frontend: response
```


<h2>2. Модель данных </h2>

1\.  Необходимо создать таблицу **```user_cards```**, которая будет хранить информацию о сохраненных работником картах, на которые он может получать выплаты. Таблица должна содержать следующие поля:  

|**код поля** |**формат** |**обязательность** |**уникальность** |**описание** |
| - | :-: | :-: | :-: | - |
|id |||||
|user\_id |int |да |нет |ссылка на работника, который сохранил данные карты |
|binding\_id |str |да |да |идентификатор сохраненной карты (связка клиента и данных карты), получаем от банка <br> <br> пример: "```69d6a793-afb5-79be-8ce7-63ff00a8656a```"|
|cardholder\_na me |str |да |нет |имя владельца карты <br><br>пример: "```Serikov Serik```"|
|masked\_pan |str |нет |нет |маскированный номер карты, получаем от банка <br><br>пример: "```400000**1118```"|
|expiration |str |нет |нет |дата истечения карты, получаем от банка <br><br>пример: "```203012```"|
|payment\_syste m |str |нет |нет |идентификатор платежной системы, получаем от банка <br><br>пример:<br>  - VISA;<br>- MASTERCARD;<br>- AMEX;<br>- JCB;<br>- CUP|
|status |str |нет |нет |```ACTIVE``` - пока срок карты не истек<br>```EXPIRED``` - когда срок карты истек|

2\. Необходимо создать таблицу **```organization_cards```**, которая будет хранить информацию о корпоративных картах организаций, с которых можно осуществлять выплаты. Таблица должна содержать следующие поля:  

|**код поля** |**формат** |**обязательность** |**уникальность** |**описание** |
| - | :-: | :-: | :-: | - |
|id |||||
|organization\_i d |int |да |нет |ссылка на организацию (владелец корпоративной карты)|
|binding\_id |str |да |да |идентификатор карты, организация сама получает в Личном кабинете банка <br><br>пример: "```69d6a79 3-afb5-79be-8ce7-63ff00a8656a```"|
|status |str |нет |нет |```ACTIVE``` - корпоративная карта используется для выплат <br>```ARCHIVE``` - корпоративная карты не используется для выплат, так как добавлен новый ```binding_id```|

3\. Необходимо создать таблицу **```banc_credentials```**, в которой будут храниться креды для использования сервисов банка. Таблица должна содержать следующие поля:  


|**код поля** |**формат** |**обязательность** |**уникальность** |**описание** |
| - | - | - | - | - |
|id |||||
|organization\_id |int |да |нет |ссылка на организацию (владелец корпоративной карты) |
|username |str |да |||
|password |str |нет |||

<h2>3. [Backend] Сервисы для реализации</h2>

<h3>3.1. Получение списка карт пользователя</h3>

1\.  Сервис должен принимать следующие параметры:  

в заголовках запроса: 


|**параметр** |**описание / формат** |**обязательность** |
| - | :-: | - |
|Authorization |передается bearer токен |да |
|Accept- language |kk / en / ru |нет <br><br>если не передан, то возвращать данные на русском по умолчанию|

2. Сервис должен осуществлять следующие проверки:  


|**№** |**Проверка** |**Текст ошибки** |
| - | - | - |
|1 |токен невалидный или токен не передан |<p>1. ru - Unauthorized </p><p>2. kk - Unauthorized  </p><p>3. en - Unauthorized </p>|

3\.  Сервис должен осуществлять следующее, если проверки пройдены:  

-определить по токену user-а <br>
-найти список карт по user-у со статусом ACTIVE и вернуть в ответе списком 
-по каждой карте необходимо возвращать следующую информацию:<br>
```
{
  "id": int,
  "status": "string",
  "bindingId": "string",
  "cardholderName": "string",
  "maskedPan": "string",
  "expiration": "string",
  "paymentSystem": "string",
  "user": {
    "id": int,
    "username": "string"
  }
}
```

<h3> 3.2. Создание заказа на тестовое списание</h3>

1\.  Сервис должен принимать следующие параметры:  
в заголовках запроса: 

|**параметр** |**описание / формат** |**обязательность** |
| - | :-: | - |
|Authorization |передается bearer токен |да |
|Accept- language |kk / en / ru |нет <br><br>если не передан, то возвращать данные на русском по умолчанию |

2. Сервис должен осуществлять следующие проверки:  


|**№** |**Проверка** |**Текст ошибки** |
| - | - | - |
|1 |токен невалидный или токен не пеедан |<p>1. ru - Unauthorized </p><p>2. kk - Unauthorized  </p><p>3. en - Unauthorized </p>|

3\.  Сервис должен осуществить следующее, если все проверки пройдены: 


|**Шаг** |**Описание** |**Сервисы** |
| - | - | - |
|1 |Получить из токена данные пользователя (user\_id) ||
|2 |Зарегистрировать по данному пользователю order на тестовое списание средств через сервис Банка |<p>Необходимо использовать запрос банка **POST** **payment/rest/registerPreAuth.do** со </p><p>следующими параметрами: </p><p>1. userName - логин, выданный </p><p>организации, банком для осуществления выплат с корпоративной карты </p><p>2. password - пароль, выданный организации, банком для осуществления выплат с корпоративной карты </p><p>3. amount - сумма тестового списания, отправлять "100" (1 тенге) </p><p>4. currency - идентификатор валюты, отправлять "398" (тенге) </p><p>5. returnUrl - ссылка, по которой перенаправят работника после успешного списания тестовой суммы, отправить ссылку "url" </p><p>6. orderNumber - идентификатор заказа, который задается на нашей стороне. Номера заказов не должны повторяться, поэтому необходимо направлять каждый раз заново сгенерированный номер заказа </p><p>7. clientId - идентификатор клиента, который задается на нашей стороне. у У одного clientId может быть несколько сохраненных карт. Для данного параметра можно использовать наш user\_id </p><p>**пример запроса**  </p><p>```curl --request POST \``` </p><p>**пример ответа**  </p><p>```{ "orderId": "8eb757ce-80ac-7860- a015-2e9000bac480", "formUrl": "url"  }```</p>|
|3 |Вернуть в ответе сервиса данные заказа и ссылку на веб-вью: ```{ "orderId": "8eb757ce-80ac-7860- a015-2e9000bac480", "formUrl": "url"  }```||

<h3> 3.3. Получить данные сохраненной карты и отменить оплату </h3>

1\.  Сервис должен принимать следующие параметры:  
в заголовках запроса: 

|**параметр** |**описание / формат** |**обязательность** |
| - | :-: | - |
|Authorization |передается bearer токен |да |
|Accept- language |kk / en / ru |нет <br><br>если не передан, то возвращать данные на русском по умолчанию </p>|

в теле запроса: 



|**параметр** |**описание / формат** |**обязательность** |
| - | - | - |
|orderId|информация о том, что пользователь успешно сохранил данные карты (фронтенд должен на своей стороне выловить returnUrl и сообщить об этом бэкенду) |да |

2\.  Сервис должен осуществлять следующие проверки:  



|**№** |**Проверка** |**Текст ошибки** |
| - | - | - |
|1 |токен невалидный или токен не пеедан |<p>1. ru - Unauthorized </p><p>2. kk - Unauthorized  </p><p>3. en - Unauthorized </p>|

3\.  Сервис должен осуществить следующее, если все проверки пройдены: 




<h2> 4. Используемые сервисы для интеграции</h2>

1\.  Документация банка:   *описание сервиса* <br>
2\. Все запросы в сторону банка необходимо отправлять с подписью:  *описание сервиса* 

<h2> 5. Критерии приемки </h2> 

<h3> 5.1. Сохранение карты работником </h3> 

<ol>

<b><li>Работник нажал на кнопку "Добавить карту" </li></b>
1. Работнику открывается страница банка в веб-вью 
1. чекбокс "Запомнить данные этой карты" необходимо по умолчанию заполнять и скрыть от пользователя 


<b><li>Кейс 1:</li></b>

1\.  Работник ввел данные карты и нажал на кнопку "Оплатить"  

1. с карты работника списывается тестовая сумма в 1 тенге 
1. данные его карты сохраняются в банке 
1. в системе PP сохраняются следующие реквизиты карты работника:  
   1. срок годности 
   1. маска карты (последние 4 цифры карты) 
   1. платежная система (VISA, MasterCard и т.д.) 
   1. имя владельца карты 
1. тестово списанная сумма в 1 тенге возвращается на карту работника 

<b><li>Кейс 2:</li></b>

1\.  Работник не ввел данные карты и свернул приложение  

1. если работник вернулся в приложение в течении 20 минут, то процесс продолжается и работник может ввести номер карты 
1. если работник вернулся в приложение более чем через 20 минут, то процесс завершается 

<b><li>Кейс 3:</li></b>
1. Работник не ввел данные карты и закрыл веб-вью  
   1. если работник снова нажал на кнопку "Добавить карту", то процесс начинается заново 

</ol>
